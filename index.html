<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Динамика ВОЛС — 6-слайдовая презентация</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --rs-blue:#0033A0; --rs-blue-600:#0A47C6; --rs-accent:#00AEEF;
      --bg:#F4F7FB; --card:#fff; --ink:#0b1a2b; --muted:#5f6b7a;
      --ok:#0a7a2d; --bad:#b00020; --border:#e7edf5; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:linear-gradient(90deg,var(--rs-blue),var(--rs-blue-600));color:#fff;padding:14px 20px;z-index:5}
    header .row{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    header .btns{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:#fff;color:var(--rs-blue)}
    .btn-ghost{background:rgba(255,255,255,.14);color:#fff;border:1px solid rgba(255,255,255,.28)}
    main{max-width:1200px;margin:24px auto;padding:0 16px 80px}
    .panel{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:var(--radius);padding:18px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    input[type=file]{background:#fff;border:1px dashed var(--border);padding:10px;border-radius:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#eef5ff;border:1px solid #d4e4ff;border-radius:999px;padding:6px 10px;color:#123}
    .muted{color:var(--muted)}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:right;white-space:nowrap}
    th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:var(--card)}
    thead th{position:sticky;top:0;background:#f8fbff;text-transform:capitalize;font-size:12px;letter-spacing:.2px}
    tfoot td{font-weight:800;background:#f8fbff}
    .num-pos{color:var(--ok);font-weight:700}
    .num-neg{color:var(--bad);font-weight:700}
    .num-zero{color:var(--muted)}
    .slide{padding:22px;border:1px dashed var(--border);border-radius:16px;background:#fff}
    .slide h2{margin:0 0 12px;font-size:22px}
    .slide h3{margin:6px 0 16px;font-size:14px;color:var(--muted);font-weight:600}
    .slide .grid{align-items:stretch}
    canvas{width:100% !important;height:360px !important}
    .footer-note{margin-top:8px;font-size:12px;color:var(--muted)}
    .badge{display:inline-block;background:#eef5ff;border:1px solid #d4e4ff;border-radius:999px;padding:2px 8px;font-size:12px}
    .divider{height:1px;background:var(--border);margin:12px 0}
    @media (max-width:1024px){.grid.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Динамика ВОЛС — генерация презентации (6 слайдов)</h1>
      <div class="btns">
        <button class="btn btn-ghost" id="loadSample">Загрузить пример</button>
        <button class="btn btn-primary" id="buildBtn">Сформировать</button>
        <button class="btn btn-primary" id="exportBtn">Скачать презентацию (HTML)</button>
      </div>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="controls">
        <span class="pill">Текущий отчёт (JSON) <input type="file" id="curFile" accept=".json"></span>
        <span class="pill">Предыдущий отчёт (JSON) <input type="file" id="prevFile" accept=".json"></span>
        <span class="muted">Форматы входа: длинный список {branch,status,count} или сводный {branches,statuses,counts}.</span>
      </div>
    </div>

    <!-- LIVE-ПРОСМОТР: слайды 5 и 6 -->
    <div class="grid" style="margin-top:16px">
      <div class="slide" id="slide5">
        <h2>Слайд 5. Динамика по статусам (детализация по филиалам)</h2>
        <h3>Слева — сумма изменений по всем статусам для каждого филиала. Справа — матрица «филиал × статус».</h3>
        <div class="grid cols-2">
          <div><canvas id="chartByBranch"></canvas></div>
          <div class="table-wrap"><table id="matrixTable"></table></div>
        </div>
        <div class="footer-note">Показываем все филиалы, присутствующие в данных (ничего не обрезаем до ТОП-N).</div>
      </div>

      <div class="slide" id="slide6">
        <h2>Слайд 6. Итоговые изменения по статусам работ</h2>
        <h3>Слева — изменения по типам статусов (итого по обществу). Справа — сводная таблица по статусам.</h3>
        <div class="grid cols-2">
          <div><canvas id="chartByStatus"></canvas></div>
          <div class="table-wrap"><table id="statusTotalsTable"></table></div>
        </div>
        <div class="footer-note">Δ = текущий − предыдущий. Положительные — зелёным, отрицательные — красным.</div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <div class="badge">Подсказка</div>
      <div class="divider"></div>
      <div class="muted">
        • Если для филиала/статуса нет значений в одном из отчётов — считаем 0.<br>
        • На графиках и в таблицах учитываются <b>все филиалы</b> из данных, без исключений.<br>
        • Экспорт создаёт HTML из <b>6 слайдов</b> (5 и 6 — как здесь).
      </div>
    </div>
  </main>

  <script>
    // =========================
    // 1) Чтение и нормализация
    // =========================
    async function readJSON(file){ const txt = await file.text(); return JSON.parse(txt); }

    // Поддерживаем:
    // a) Длинный список: [{branch:'...', status:'...', count:123}, ...]
    // b) Сводный объект: { branches:[...], statuses:[...], counts:{ [branch]:{[status]:number} } }
    function normalize(data){
      if (data && Array.isArray(data.branches) && Array.isArray(data.statuses) && typeof data.counts === 'object'){
        // Сводный формат — приводим к числам и добиваем нулями
        const branches = [...data.branches];
        const statuses = [...data.statuses];
        const counts = {};
        branches.forEach(b=>{
          counts[b] = counts[b] || {};
          statuses.forEach(s=> counts[b][s] = Number((data.counts[b]||{})[s] ?? 0));
        });
        return {branches, statuses, counts};
      }
      if (Array.isArray(data)){
        // Длинный список — агрегируем
        const branchesSet = new Set();
        const statusesSet = new Set();
        const counts = {};
        for (const row of data){
          const b = row.branch ?? row.filial ?? row.Branch ?? row['Филиал'];
          const s = row.status ?? row.Status ?? row['Статус'];
          const v = Number(row.count ?? row.value ?? row['Количество'] ?? 0);
          if (!b || !s) continue;
          if (!counts[b]) counts[b] = {};
          counts[b][s] = (counts[b][s]||0) + v;
          if (!branchesSet.has(b)) branchesSet.add(b);
          if (!statusesSet.has(s)) statusesSet.add(s);
        }
        const branches = [...branchesSet];
        const statuses = [...statusesSet];
        branches.forEach(b=> statuses.forEach(s=> counts[b][s] = Number(counts[b][s]||0)));
        return {branches, statuses, counts};
      }
      if (data && typeof data === 'object'){
        // Объект вида { "Филиал": { "Статус": число } }
        const branches = Object.keys(data);
        const sset = new Set();
        branches.forEach(b=> Object.keys(data[b]||{}).forEach(s=> sset.add(s)));
        const statuses = [...sset];
        const counts = {};
        branches.forEach(b=>{
          counts[b] = {};
          statuses.forEach(s=> counts[b][s] = Number((data[b]||{})[s]||0));
        });
        return {branches, statuses, counts};
      }
      throw new Error('Неизвестный формат JSON');
    }

    // Объединяем множества с сохранением пользовательского порядка:
    // сначала порядок current, затем добавляем недостающие из previous.
    function unify(cur, prev){
      const branches = [...(cur?.branches||[])];
      (prev?.branches||[]).forEach(b=>{ if(!branches.includes(b)) branches.push(b); });
      const statuses = [...(cur?.statuses||[])];
      (prev?.statuses||[]).forEach(s=>{ if(!statuses.includes(s)) statuses.push(s); });

      function toMatrix(src){
        const counts = {};
        branches.forEach(b=>{
          counts[b] = {};
          statuses.forEach(s=>{
            counts[b][s] = Number(((src?.counts||{})[b]||{})[s]??0);
          });
        });
        return {branches, statuses, counts};
      }
      return { cur: toMatrix(cur), prev: toMatrix(prev) };
    }

    // Δ = current - previous + агрегаты
    function computeDelta(unified){
      const {cur, prev} = unified;
      const {branches, statuses} = cur;
      const delta = {};
      const totalsByStatus = {};
      const sumByBranch = {};
      statuses.forEach(s=> totalsByStatus[s] = 0);
      branches.forEach(b=>{
        delta[b] = {};
        sumByBranch[b] = 0;
        statuses.forEach(s=>{
          const v = Number(cur.counts[b][s] - prev.counts[b][s]);
          delta[b][s] = v;
          totalsByStatus[s] += v;
          sumByBranch[b] += v;
        });
      });
      return {branches, statuses, deltaByBranchStatus: delta, totalsByStatus, sumByBranch};
    }

    // =========================
    // 2) Рендер превью (5-6)
    // =========================
    let chartBranch, chartStatus;

    function numCell(v){
      const n = Number(v)||0;
      const cls = n>0 ? 'num-pos' : (n<0 ? 'num-neg' : 'num-zero');
      const sign = n>0 ? '+' : '';
      return `<span class="${cls}">${sign}${n}</span>`;
    }

    function renderMatrixTable(brs, sts, delta){
      const head = ['<th>Филиал</th>', ...sts.map(s=>`<th>${s}</th>`), '<th>Итого</th>'].join('');
      const rows = brs.map(b=>{
        let sum = 0;
        const cells = sts.map(s=>{
          const v = Number((delta[b]||{})[s]||0);
          sum += v;
          return `<td>${numCell(v)}</td>`;
        }).join('');
        return `<tr><td>${b}</td>${cells}<td>${numCell(sum)}</td></tr>`;
      }).join('');
      const totalsRow = sts.map(s=>{
        const v = brs.reduce((acc,b)=> acc + Number((delta[b]||{})[s]||0), 0);
        return `<td>${numCell(v)}</td>`;
      }).join('');
      const grand = brs.reduce((acc,b)=> acc + sts.reduce((a,s)=> a + Number((delta[b]||{})[s]||0), 0), 0);
      const foot = `<tr><td><b>Итого</b></td>${totalsRow}<td><b>${numCell(grand)}</b></td></tr>`;
      document.getElementById('matrixTable').innerHTML =
        `<thead><tr>${head}</tr></thead><tbody>${rows}</tbody><tfoot>${foot}</tfoot>`;
    }

    function renderStatusTotalsTable(sts, totals){
      const head = '<thead><tr><th>Статус</th><th>Δ (итого)</th></tr></thead>';
      const body = sts.map(s=> `<tr><td>${s}</td><td>${numCell(totals[s]||0)}</td></tr>`).join('');
      document.getElementById('statusTotalsTable').innerHTML = head + `<tbody>${body}</tbody>`;
    }

    function renderCharts(sumByBranch, totalsByStatus){
      // Слайд 5 — по филиалам
      const brLabels = Object.keys(sumByBranch);
      const brValues = brLabels.map(b=> Number(sumByBranch[b]||0));
      if (chartBranch) chartBranch.destroy();
      chartBranch = new Chart(document.getElementById('chartByBranch'), {
        type:'bar',
        data:{ labels: brLabels, datasets:[{ label:'Δ по всем статусам', data: brValues }]},
        options:{
          responsive:true,
          plugins:{ legend:{ display:true }, tooltip:{enabled:true} },
          scales:{ x:{ ticks:{ autoSkip:false, maxRotation:60 } }, y:{ beginAtZero:true } }
        }
      });

      // Слайд 6 — по статусам
      const stLabels = Object.keys(totalsByStatus);
      const stValues = stLabels.map(s=> Number(totalsByStatus[s]||0));
      if (chartStatus) chartStatus.destroy();
      chartStatus = new Chart(document.getElementById('chartByStatus'), {
        type:'bar',
        data:{ labels: stLabels, datasets:[{ label:'Δ по статусам (итого)', data: stValues }]},
        options:{
          responsive:true,
          plugins:{ legend:{ display:true }, tooltip:{enabled:true} },
          scales:{ x:{ ticks:{ autoSkip:false, maxRotation:60 } }, y:{ beginAtZero:true } }
        }
      });
    }

    // =========================
    // 3) Экспорт 6-слайдового HTML
    // =========================
    function exportPresentationHTML(payload){
      const doc = `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>\${payload.meta.title}</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  body{margin:0;background:#F4F7FB;color:#0b1a2b;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .deck{max-width:1200px;margin:24px auto;padding:0 16px 80px;display:grid;gap:18px}
  .slide{background:#fff;border:1px solid #e7edf5;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px}
  h1,h2,h3{margin:0 0 12px}
  h1{font-size:26px} h2{font-size:22px} h3{font-size:14px;color:#5f6b7a}
  .grid{display:grid;gap:16px} .grid.cols-2{grid-template-columns:1fr 1fr}
  .table-wrap{overflow:auto;border:1px solid #e7edf5;border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
  th,td{padding:10px 12px;border-bottom:1px solid #e7edf5;text-align:right;white-space:nowrap}
  th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:#fff}
  thead th{position:sticky;top:0;background:#f8fbff;text-transform:capitalize;font-size:12px;letter-spacing:.2px}
  tfoot td{font-weight:800;background:#f8fbff}
  .num-pos{color:#0a7a2d;font-weight:700}
  .num-neg{color:#b00020;font-weight:700}
  .num-zero{color:#5f6b7a}
  canvas{width:100% !important;height:360px !important}
  @media (max-width:1024px){.grid.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="deck">
  <div class="slide"><h1>\${payload.meta.h1}</h1><h3>\${payload.meta.sub}</h3><p class="muted">Слайд 1 — титульный.</p></div>
  <div class="slide"><h2>Слайд 2 — резерв</h2><h3>Ваш контент</h3></div>
  <div class="slide"><h2>Слайд 3 — резерв</h2><h3>Ваш контент</h3></div>
  <div class="slide"><h2>Слайд 4 — резерв</h2><h3>Ваш контент</h3></div>

  <div class="slide">
    <h2>Слайд 5. Динамика по статусам (детализация по филиалам)</h2>
    <h3>Слева — сумма изменений по всем статусам для каждого филиала. Справа — матрица «филиал × статус».</h3>
    <div class="grid cols-2">
      <div><canvas id="chartByBranchExp"></canvas></div>
      <div class="table-wrap"><table id="matrixTableExp"></table></div>
    </div>
  </div>

  <div class="slide">
    <h2>Слайд 6. Итоговые изменения по статусам работ</h2>
    <h3>Слева — изменения по типам статусов (итого по обществу). Справа — сводная таблица по статусам.</h3>
    <div class="grid cols-2">
      <div><canvas id="chartByStatusExp"></canvas></div>
      <div class="table-wrap"><table id="statusTotalsTableExp"></table></div>
    </div>
  </div>
</div>

<script>
  const DATA = \${JSON.stringify(payload)};

  function numCell(v){
    const n = Number(v)||0;
    const cls = n>0 ? 'num-pos' : (n<0 ? 'num-neg' : 'num-zero');
    const sign = n>0 ? '+' : '';
    return '<span class="'+cls+'">'+sign+n+'</span>';
  }

  function renderMatrixTable(targetId, brs, sts, delta){
    const th = ['<th>Филиал</th>', ...sts.map(s=>'<th>'+s+'</th>'), '<th>Итого</th>'].join('');
    const rows = brs.map(b=>{
      let sum = 0;
      const tds = sts.map(s=>{
        const v = Number((delta[b]||{})[s]||0);
        sum += v; return '<td>'+numCell(v)+'</td>';
      }).join('');
      return '<tr><td>'+b+'</td>'+tds+'<td>'+numCell(sum)+'</td></tr>';
    }).join('');
    const totals = sts.map(s=>{
      const v = brs.reduce((acc,b)=> acc + Number((delta[b]||{})[s]||0), 0);
      return '<td>'+numCell(v)+'</td>';
    }).join('');
    const grand = brs.reduce((acc,b)=> acc + sts.reduce((a,s)=> a + Number((delta[b]||{})[s]||0), 0), 0);
    const tf = '<tr><td><b>Итого</b></td>'+totals+'<td><b>'+numCell(grand)+'</b></td></tr>';
    document.getElementById(targetId).innerHTML = '<thead><tr>'+th+'</tr></thead><tbody>'+rows+'</tbody><tfoot>'+tf+'</tfoot>';
  }

  function renderStatusTotalsTable(targetId, sts, totals){
    const head = '<thead><tr><th>Статус</th><th>Δ (итого)</th></tr></thead>';
    const body = sts.map(s=> '<tr><td>'+s+'</td><td>'+numCell(Number(totals[s]||0))+'</td></tr>').join('');
    document.getElementById(targetId).innerHTML = head + '<tbody>'+body+'</tbody>';
  }

  function renderCharts(){
    const brLabels = Object.keys(DATA.slide5.sumByBranch);
    const brValues = brLabels.map(b=> Number(DATA.slide5.sumByBranch[b]||0));
    new Chart(document.getElementById('chartByBranchExp'), {
      type:'bar',
      data:{ labels: brLabels, datasets:[{ label:'Δ по всем статусам', data: brValues }]},
      options:{ responsive:true, plugins:{ legend:{display:true} }, scales:{ y:{beginAtZero:true}, x:{ticks:{autoSkip:false,maxRotation:60}} } }
    });

    const stLabels = Object.keys(DATA.slide6.totalsByStatus);
    const stValues = stLabels.map(s=> Number(DATA.slide6.totalsByStatus[s]||0));
    new Chart(document.getElementById('chartByStatusExp'), {
      type:'bar',
      data:{ labels: stLabels, datasets:[{ label:'Δ по статусам (итого)', data: stValues }]},
      options:{ responsive:true, plugins:{ legend:{display:true} }, scales:{ y:{beginAtZero:true}, x:{ticks:{autoSkip:false,maxRotation:60}} } }
    });
  }

  renderMatrixTable('matrixTableExp', DATA.slide5.branches, DATA.slide5.statuses, DATA.slide5.deltaByBranchStatus);
  renderStatusTotalsTable('statusTotalsTableExp', DATA.slide6.statuses, DATA.slide6.totalsByStatus);
  renderCharts();
</script>
</body>
</html>`;
      const blob = new Blob([doc], {type:'text/html;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'prezentaciya_vols_6_slides.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // =========================
    // 4) Глобальное состояние и UI
    // =========================
    const state = { current:null, previous:null, result:null };

    async function build(){
      if (!state.current || !state.previous){
        alert('Загрузите оба файла (текущий и предыдущий) или нажмите «Загрузить пример».');
        return;
      }
      const curN = normalize(state.current);
      const prevN = normalize(state.previous);
      const uni = unify(curN, prevN);
      const res = computeDelta(uni);
      state.result = res;

      renderMatrixTable(res.branches, res.statuses, res.deltaByBranchStatus);
      renderStatusTotalsTable(res.statuses, res.totalsByStatus);
      renderCharts(res.sumByBranch, res.totalsByStatus);
    }

    document.getElementById('buildBtn').addEventListener('click', build);

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      if (!state.result){ alert('Сначала нажмите «Сформировать».'); return; }
      const payload = {
        meta:{ title:'Динамика ВОЛС — презентация (6 слайдов)', h1:'АО «Россети Кубань» — Еженедельная динамика', sub:'Автоматически сгенерировано' },
        slide5:{
          branches: state.result.branches,
          statuses: state.result.statuses,
          deltaByBranchStatus: state.result.deltaByBranchStatus,
          sumByBranch: state.result.sumByBranch
        },
        slide6:{
          statuses: state.result.statuses,
          totalsByStatus: state.result.totalsByStatus
        }
      };
      exportPresentationHTML(payload);
    });

    // Пример данных на 11 филиалов и 6 статусов для быстрого теста
    document.getElementById('loadSample').addEventListener('click', ()=>{
      const branches = [
        'Краснодарские ЭС','Тимашевские ЭС','Усть-Лабинские ЭС','Юго-Западные ЭС',
        'Северо-Кубанские ЭС','Ейские ЭС','Сочинские ЭС','Туапсинские ЭС',
        'Адыгейские ЭС','Апшеронские ЭС','Славянские ЭС'
      ];
      const statuses = [
        'В работе у филиала','Демонтировано','РЦ',
        'Будет включено в следующее ДС','Отказ оператора','На рассмотрении'
      ];
      function randomCounts(mult=80){
        const counts = {};
        branches.forEach(b=>{
          counts[b] = {};
          statuses.forEach(s=>{ counts[b][s] = Math.round(Math.random()*mult); });
        });
        return {branches:[...branches], statuses:[...statuses], counts};
      }
      const prev = randomCounts(80);
      const cur = JSON.parse(JSON.stringify(prev));
      branches.forEach(b=>{
        statuses.forEach(s=>{
          cur.counts[b][s] = Math.max(0, prev.counts[b][s] + Math.round((Math.random()-0.4)*20));
        });
      });
      state.current = cur;
      state.previous = prev;
      build();
    });

    // Загрузка файлов
    document.getElementById('curFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{ state.current = await readJSON(f); }catch(err){ alert('Ошибка чтения текущего JSON: '+err.message); }
    });
    document.getElementById('prevFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{ state.previous = await readJSON(f); }catch(err){ alert('Ошибка чтения предыдущего JSON: '+err.message); }
    });
  </script>
</body>
</html>
